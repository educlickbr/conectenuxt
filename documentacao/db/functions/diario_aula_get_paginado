CREATE OR REPLACE FUNCTION public.diario_aula_get_paginado(p_id_empresa uuid, p_pagina integer DEFAULT 1, p_limite_itens_pagina integer DEFAULT 10, p_id_turma uuid DEFAULT NULL::uuid, p_id_componente uuid DEFAULT NULL::uuid, p_data_inicio date DEFAULT NULL::date, p_data_fim date DEFAULT NULL::date)
 RETURNS json
 LANGUAGE plpgsql
 STABLE
AS $function$
DECLARE
    v_offset integer;
    v_total_itens integer;
    v_total_paginas integer;
    v_itens json;
BEGIN
    v_offset := (p_pagina - 1) * p_limite_itens_pagina;

    SELECT COUNT(*) INTO v_total_itens
    FROM public.diario_aula d
    WHERE d.id_empresa = p_id_empresa
      AND (p_id_turma IS NULL OR d.id_turma = p_id_turma)
      AND (p_id_componente IS NULL OR d.id_componente = p_id_componente)
      AND (p_data_inicio IS NULL OR d.data >= p_data_inicio)
      AND (p_data_fim IS NULL OR d.data <= p_data_fim);

    IF p_limite_itens_pagina > 0 THEN
        v_total_paginas := CEIL(v_total_itens::numeric / p_limite_itens_pagina);
    ELSE
        v_total_paginas := 0; 
    END IF;

    SELECT COALESCE(json_agg(t), '[]'::json) INTO v_itens
    FROM (
        SELECT 
            d.*,
            u.nome_completo as professor_nome,
            c.nome as componente_nome,
            -- Plan Info
            p.titulo as plano_titulo,
            pi.aula_numero as plano_aula_numero
        FROM public.diario_aula d
        LEFT JOIN public.user_expandido u ON u.id = d.registrado_por
        LEFT JOIN public.componente c ON c.uuid = d.id_componente
        LEFT JOIN public.pl_plano_de_aulas_itens pi ON pi.id = d.id_plano_aula_item
        LEFT JOIN public.pl_plano_de_aulas p ON p.id = pi.id_plano_de_aula
        WHERE d.id_empresa = p_id_empresa
          AND (p_id_turma IS NULL OR d.id_turma = p_id_turma)
          AND (p_id_componente IS NULL OR d.id_componente = p_id_componente)
          AND (p_data_inicio IS NULL OR d.data >= p_data_inicio)
          AND (p_data_fim IS NULL OR d.data <= p_data_fim)
        ORDER BY d.data DESC, d.registrado_em DESC
        LIMIT p_limite_itens_pagina
        OFFSET v_offset
    ) t;

    RETURN json_build_object(
        'qtd_itens', v_total_itens,
        'qtd_paginas', v_total_paginas,
        'itens', v_itens
    );
END;
$function$
